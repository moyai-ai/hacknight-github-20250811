#!/usr/bin/env bash
# Quick start script for AST Code Chunker in Flox environment

set -e

echo "üöÄ AST Code Chunker Quick Start"
echo "================================"
echo ""

# Get the directory of this script
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"

# Check if we're in a Flox environment - if not, activate it
if [ -z "$FLOX_ENV" ]; then
    echo "üì¶ Activating Flox environment..."
    cd "$PROJECT_DIR"
    
    # Run everything in the Flox environment
    flox activate -- bash -c '
        # Step 1: Start services
        echo "1Ô∏è‚É£  Starting services..."
        flox services start weaviate &
        flox services start ollama &
        echo "Waiting for services to start (30 seconds)..."
        sleep 30
        
        # Step 2: Initialize models
        echo ""
        echo "2Ô∏è‚É£  Initializing models..."
        python "$FLOX_ENV_PROJECT/cli.py" init-models
        
        # Step 3: Initialize schema
        echo ""
        echo "3Ô∏è‚É£  Initializing Weaviate schema..."
        python "$FLOX_ENV_PROJECT/cli.py" init-schema
        
        # Keep the environment active
        echo ""
        echo "‚úÖ Setup complete! Services are running."
        echo ""
        echo "The environment will stay active. Press Ctrl+C to stop."
        echo ""
        echo "In another terminal, run:"
        echo "  cd $(pwd)"
        echo "  flox activate"
        echo ""
        echo "Then use the AST chunker commands as shown below."
        
        # Keep services running
        wait
    '
else
    # We're already in a Flox environment
    # Step 1: Check services
    echo "1Ô∏è‚É£  Checking services..."
    python "$FLOX_ENV_PROJECT/cli.py" check-services || {
        echo ""
        echo "Starting services..."
        flox services start weaviate &
        flox services start ollama &
        echo "Waiting for services to start (30 seconds)..."
        sleep 30
    }
    
    # Step 2: Initialize models
    echo ""
    echo "2Ô∏è‚É£  Initializing models..."
    python "$FLOX_ENV_PROJECT/cli.py" init-models
    
    # Step 3: Initialize schema
    echo ""
    echo "3Ô∏è‚É£  Initializing Weaviate schema..."
    python "$FLOX_ENV_PROJECT/cli.py" init-schema
fi

# Step 4: Show example commands
echo ""
echo "‚úÖ Setup complete! Here are some example commands:"
echo ""
echo "Index a file:"
echo "  ast-chunk index-file example.py"
echo ""
echo "Index a directory:"
echo "  ast-chunk index-directory ./src -e .py -e .js"
echo ""
echo "Search your code:"
echo "  ast-chunk search 'database connection'"
echo ""
echo "Ask questions:"
echo "  ast-chunk ask 'How does the authentication work?'"
echo ""
echo "View statistics:"
echo "  ast-chunk stats"